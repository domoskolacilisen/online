<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Domoškola Líšeň - CMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; font-style: normal; }
        
        .card-modra { background-color: #eff6ff; border-color: #bfdbfe; }
        .card-zelena { background-color: #ecfdf5; border-color: #a7f3d0; }
        .card-cervena { background-color: #fef2f2; border-color: #fecaca; }
        .card-zluta { background-color: #fefce8; border-color: #fef08a; }
        .card-fialova { background-color: #faf5ff; border-color: #e9d5ff; }
        .card-oranzova { background-color: #fff7ed; border-color: #fed7aa; }
        .card-seda { background-color: #f8fafc; border-color: #e2e8f0; }

        .btn-modra { background-color: #2563eb !important; }
        .btn-zelena { background-color: #059669 !important; }
        .btn-cervena { background-color: #dc2626 !important; }
        .btn-zluta { background-color: #ca8a04 !important; }
        .btn-fialova { background-color: #7c3aed !important; }
        .btn-oranzova { background-color: #ea580c !important; }
        .btn-seda { background-color: #475569 !important; }
        
        .animate-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .modal-overlay { background-color: rgba(15, 23, 42, 0.7); backdrop-filter: blur(8px); }
        
        .custom-checkbox { width: 22px; height: 22px; border-radius: 6px; border: 2px solid #cbd5e1; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
        .custom-checkbox.checked { background-color: #2563eb; border-color: #2563eb; color: white; }

        .pulse-yellow { animation: pulseY 1.5s infinite; background-color: #fef9c3; color: #854d0e; }
        @keyframes pulseY { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        .toast-enter { animation: slideUp 0.3s ease-out forwards; }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 overflow-x-hidden">

    <script>
        const SHEET_ID = "1j9Hi-SdfaK5Sf6-2Tas6_2aP70EZUlsF2jHU2nLa-gs"; 
        const API_KEY = "AIzaSyAaqDFxLXvfQAifEnX2pcRs3a5ctAdV3II"; 
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwYrc9z4UmbZ8JKYK8Gtr03ukacuA51weoGhUtAEYjv5y1ilLWpwwIslilhy3NnnWAgCw/exec"; 
    </script>

    <div id="app">
        <div class="min-h-screen flex items-center justify-center bg-blue-600 text-white font-bold uppercase text-center p-6 tracking-widest">
            <div>Načítám CMS portál Domoškola Líšeň...</div>
        </div>
    </div>

    <script>
        let state = {
            user: JSON.parse(localStorage.getItem('domoskola_user')) || null,
            loading: true,
            materials: [],
            usersDb: [], 
            config: [], 
            activeGrade: "Vše",
            activeSubject: "Vše",
            searchQuery: "",
            manageSearchQuery: "",
            manageActiveGrade: "Vše",
            manageActiveSubject: "Vše",
            viewMode: "portal", // portal, manage, config
            selectedItems: [],
            processingIds: [],
            toast: null,
            confirmModal: null, // { title: string, text: string, onConfirm: function }
            showUploadModal: false,
            showEditModal: null,
            configEditingItem: null,
            actionLoading: false,
            loginError: ""
        };

        // --- DATA FETCH ---
        async function fetchData() {
            try {
                const configResp = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getInitialData' }) });
                const configData = await configResp.json();
                state.config = configData.config || [];

                const fetchSheet = async (range) => {
                    const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${range}?key=${API_KEY}`);
                    const result = await response.json();
                    if (!result.values) return [];
                    const [headers, ...rows] = result.values;
                    return rows.map(row => {
                        const obj = {};
                        headers.forEach((header, i) => { obj[header.toLowerCase().trim()] = (row[i] || "").toString().trim(); });
                        return obj;
                    });
                };
                
                const [mats, usrs] = await Promise.all([
                    fetchSheet('Materialy!A1:Z1000'),
                    fetchSheet('Uzivatele!A1:E500')
                ]);
                
                state.materials = mats;
                state.usersDb = usrs;
            } catch (err) { console.error(err); } 
            finally { state.loading = false; render(); }
        }

        function showToast(message) {
            state.toast = message; render();
            setTimeout(() => { if(state.toast === message) { state.toast = null; render(); } }, 3500);
        }

        function askConfirm(title, text, onConfirm) {
            state.confirmModal = { title, text, onConfirm };
            render();
        }

        // --- ACTIONS ---
        async function runAction(action, ids, extraData = {}) {
            state.processingIds = [...state.processingIds, ...ids];
            if (action === 'updateStatus') {
                state.materials = state.materials.map(m => ids.includes(m.id) ? {...m, status: m.status === 'publikovano' ? 'neaktivni' : 'publikovano'} : m);
            } else if (action === 'delete') {
                state.materials = state.materials.filter(m => !ids.includes(m.id));
                state.selectedItems = [];
            } else if (action === 'edit') {
                state.materials = state.materials.map(m => m.id === extraData.id ? {...m, ...extraData} : m);
                state.showEditModal = null;
            }
            render();

            try {
                const stringIds = ids.map(id => id.toString());
                await fetch(APPS_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action, ids: stringIds, ...extraData }) });
                setTimeout(() => {
                    state.processingIds = state.processingIds.filter(id => !ids.includes(id));
                    showToast("Změny byly uloženy na server."); render();
                }, 1000);
            } catch (e) {
                state.processingIds = state.processingIds.filter(id => !ids.includes(id)); render();
            }
        }

        async function handleUpload(e) {
            e.preventDefault();
            const fileInput = document.getElementById('uploadFile');
            const file = fileInput.files[0];
            const meta = {
                nazev: document.getElementById('metaNazev').value.trim(),
                trida: document.getElementById('metaTrida').value,
                predmet: document.getElementById('metaPredmet').value,
                typ: document.getElementById('metaTyp').value,
                poznamka: document.getElementById('metaPoznamka').value.trim(),
                tagy: document.getElementById('metaTagy').value.trim()
            };
            state.actionLoading = true; render();
            const reader = new FileReader();
            reader.onload = async function() {
                const base64 = reader.result.split(',')[1];
                await fetch(APPS_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'upload', filename: file.name, mimeType: file.type, base64, ...meta }) });
                setTimeout(() => { 
                    state.actionLoading = false; state.showUploadModal = false; showToast("Materiál úspěšně nahrán."); fetchData(); 
                }, 3000);
            };
            reader.readAsDataURL(file);
        }

        async function handleConfigSave(e) {
            e.preventDefault();
            const kat = document.getElementById('cfgKat').value;
            const nazev = document.getElementById('cfgNazev').value.trim();
            const val = kat === 'Predmet' ? document.getElementById('cfgVal').value : "";
            const newItem = { kategorie: kat, nazev: nazev, hodnota: val };

            state.actionLoading = true; render();

            if (state.configEditingItem) {
                await fetch(APPS_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'deleteConfig', configItem: state.configEditingItem }) });
            }
            
            await fetch(APPS_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'saveConfig', configItem: newItem }) });
            
            state.configEditingItem = null;
            state.actionLoading = false;
            showToast("Nastavení systému aktualizováno.");
            fetchData();
        }

        function getCardColor(predmet) {
            const item = state.config.find(c => c.kategorie === 'Predmet' && c.nazev === predmet);
            return item ? item.hodnota : "seda";
        }

        // --- RENDER SECTIONS ---

        function renderPortalHTML() {
            const filtered = state.materials.filter(m => {
                const gMatch = state.activeGrade === "Vše" || m.trida === state.activeGrade;
                const sMatch = state.activeSubject === "Vše" || m.predmet === state.activeSubject;
                const qMatch = (m.nazev + m.tagy + m.predmet + (m.poznamka || "")).toLowerCase().includes(state.searchQuery.toLowerCase());
                return gMatch && sMatch && qMatch && m.status === 'publikovano';
            });
            const subList = state.config.filter(c => c.kategorie === 'Predmet').map(c => c.nazev).sort();

            return `<div class="animate-in">
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-3xl font-bold text-blue-900">${state.activeGrade}</h2>
                    <div class="flex gap-2">
                        ${state.user?.role === 'admin' ? `
                            <button onclick="state.viewMode='manage'; render()" class="p-3 bg-white text-blue-600 border border-blue-100 rounded-2xl text-[10px] font-bold uppercase shadow-sm flex items-center gap-2 hover:bg-blue-50 transition-all">
                                <i data-lucide="settings" class="w-4 h-4"></i> Administrace dat
                            </button>
                            <button onclick="state.showUploadModal=true; render()" class="p-3 bg-emerald-600 text-white rounded-2xl text-[10px] font-bold uppercase shadow-lg flex items-center gap-2 active:scale-95 transition-all">
                                <i data-lucide="plus-circle" class="w-4 h-4"></i> Nahrát nový
                            </button>
                        ` : ''}
                    </div>
                </div>
                <div class="flex flex-wrap gap-2 mb-10">
                    ${[...subList, "Vše"].map(s => `<button onclick="state.activeSubject='${s}'; render()" class="px-5 py-3 rounded-2xl text-[10px] font-bold uppercase transition-all ${state.activeSubject === s ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-blue-400 border border-blue-100 hover:bg-blue-50'}">${s}</button>`).join('')}
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 pb-20">
                    ${filtered.map(m => `
                    <div class="card-${getCardColor(m.predmet)} border-2 rounded-[2rem] p-8 hover:shadow-xl transition-all group flex flex-col justify-between relative overflow-hidden">
                        ${state.user?.role === 'admin' ? `<button onclick="state.showEditModal=${JSON.stringify(m).replace(/"/g, '&quot;')}; render();" class="absolute top-4 right-4 p-2 bg-white/60 text-blue-600 rounded-xl hover:bg-white shadow-sm transition-all"><i data-lucide="edit-3" class="w-4 h-4"></i></button>` : ''}
                        <div>
                            <span class="px-4 py-1.5 text-[10px] font-bold uppercase rounded-full border border-current opacity-70 mb-6 inline-block font-mono tracking-widest leading-none">${m.predmet}</span>
                            <h3 class="text-2xl font-bold text-slate-800 mb-2 leading-tight">${m.nazev}</h3>
                            <p class="text-slate-500 text-sm mb-8 leading-relaxed line-clamp-2 min-h-[3rem]">${m.poznamka || ''}</p>
                        </div>
                        <div class="pt-6 border-t border-white/50 flex flex-col gap-4">
                            <div class="flex justify-between text-[10px] font-bold text-slate-400 uppercase tracking-widest"><span>${m.datum}</span><span>${m.typ}</span></div>
                            <a href="${m.odkaz}" target="_blank" class="w-full flex items-center justify-center gap-3 text-white py-4 rounded-2xl text-[11px] font-bold uppercase shadow-lg active:scale-95 btn-${getCardColor(m.predmet)}">Otevřít podklady</a>
                        </div>
                    </div>`).join('')}
                </div>
            </div>`;
        }

        function renderManageHTML() {
            const filtered = state.materials.filter(m => {
                const gMatch = state.manageActiveGrade === "Vše" || m.trida === state.manageActiveGrade;
                const sMatch = state.manageActiveSubject === "Vše" || m.predmet === state.manageActiveSubject;
                const qMatch = (m.nazev + m.predmet).toLowerCase().includes(state.manageSearchQuery.toLowerCase());
                return gMatch && sMatch && qMatch;
            });
            const grades = ["Vše", ...state.config.filter(c => c.kategorie === 'Trida').map(c => c.nazev).sort()];
            const subjects = ["Vše", ...state.config.filter(c => c.kategorie === 'Predmet').map(c => c.nazev).sort()];

            return `<div class="animate-in">
                <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between mb-8 gap-4">
                    <h2 class="text-3xl font-bold text-blue-900 uppercase">Správa obsahu</h2>
                    <div class="flex gap-2 w-full lg:w-auto">
                        <button onclick="state.viewMode='config'; render()" class="flex-1 lg:flex-none px-5 py-3 bg-white text-blue-600 border border-blue-100 rounded-2xl text-[10px] font-bold uppercase flex items-center gap-2 shadow-sm hover:bg-blue-50 transition-all"><i data-lucide="layers" class="w-4 h-4"></i> Nastavení systému</button>
                        <button onclick="runAction('updateStatus', state.selectedItems)" class="px-4 py-3 bg-blue-600 text-white rounded-xl text-[10px] font-bold uppercase shadow-lg disabled:opacity-30" ${state.selectedItems.length === 0 ? 'disabled' : ''}>Status (${state.selectedItems.length})</button>
                        <button onclick="askConfirm('Smazat materiály?', 'Opravdu chcete vybrané položky trvale smazat?', () => runAction('delete', state.selectedItems))" class="px-4 py-3 bg-red-600 text-white rounded-xl text-[10px] font-bold uppercase shadow-lg disabled:opacity-30" ${state.selectedItems.length === 0 ? 'disabled' : ''}>Smazat</button>
                        <button onclick="state.viewMode='portal'; render()" class="p-3 bg-slate-200 rounded-xl hover:text-red-500 transition-all"><i data-lucide="x"></i></button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    <input type="text" oninput="state.manageSearchQuery=this.value; render()" value="${state.manageSearchQuery}" placeholder="Hledat v seznamu..." class="p-4 bg-white border border-slate-200 rounded-2xl text-sm outline-none focus:ring-2 focus:ring-blue-600">
                    <select onchange="state.manageActiveGrade=this.value; render()" class="p-4 bg-white border rounded-2xl text-sm">${grades.map(g => `<option ${state.manageActiveGrade===g?'selected':''}>${g}</option>`).join('')}</select>
                    <select onchange="state.manageActiveSubject=this.value; render()" class="p-4 bg-white border rounded-2xl text-sm">${subjects.map(s => `<option ${state.manageActiveSubject===s?'selected':''}>${s}</option>`).join('')}</select>
                </div>
                <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden shadow-sm overflow-x-auto">
                    <table class="w-full text-left text-sm whitespace-nowrap">
                        <thead class="bg-slate-50 border-b text-[10px] font-bold uppercase text-slate-400"><tr><th class="p-6 w-10"></th><th class="p-6">Materiál</th><th class="p-6">Stav</th><th class="p-6 text-right">Edit</th></tr></thead>
                        <tbody class="divide-y divide-slate-100">${filtered.map(m => `
                            <tr class="hover:bg-slate-50/50 ${state.selectedItems.includes(m.id)?'bg-blue-50/30':''}">
                                <td class="p-6"><div onclick="state.selectedItems.includes('${m.id}')?state.selectedItems=state.selectedItems.filter(i=>i!=='${m.id}'):state.selectedItems.push('${m.id}'); render();" class="custom-checkbox ${state.selectedItems.includes(m.id)?'checked':''}">
                                ${state.selectedItems.includes(m.id)?'<i data-lucide="check" class="w-3 h-3"></i>':''}</div></td>
                                <td class="p-6"><b>${m.nazev}</b><br><small class="text-slate-400 uppercase font-bold text-[9px]">${m.predmet} • ${m.trida}</small></td>
                                <td class="p-6">
                                    ${state.processingIds.includes(m.id)?'<span class="pulse-yellow px-3 py-1 rounded-full text-[9px] font-bold uppercase">Ukládám...</span>':
                                    `<span onclick="runAction('updateStatus', ['${m.id}'])" class="cursor-pointer px-3 py-1 rounded-full text-[9px] font-bold uppercase ${m.status==='publikovano'?'bg-emerald-50 text-emerald-600':'bg-red-50 text-red-400'}">${m.status==='publikovano'?'Veřejné':'Skryté'}</span>`}
                                </td>
                                <td class="p-6 text-right"><button onclick="state.showEditModal=${JSON.stringify(m).replace(/"/g, '&quot;')}; render();" class="p-2 text-blue-400 hover:bg-blue-50 rounded-xl transition-all"><i data-lucide="edit-3" class="w-5 h-5"></i></button></td>
                            </tr>`).join('')}</tbody>
                    </table>
                </div>
            </div>`;
        }

        function renderConfigHTML() {
            const subjects = state.config.filter(c => c.kategorie === 'Predmet').sort((a,b) => a.nazev.localeCompare(b.nazev));
            const grades = state.config.filter(c => c.kategorie === 'Trida').sort((a,b) => a.nazev.localeCompare(b.nazev));
            const types = state.config.filter(c => c.kategorie === 'Typ').sort((a,b) => a.nazev.localeCompare(b.nazev));
            const currentKat = state.configEditingItem?.kategorie || (document.getElementById('cfgKat') ? document.getElementById('cfgKat').value : 'Predmet');

            return `<div class="animate-in flex flex-col">
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-3xl font-bold text-blue-900 uppercase tracking-tight">Nastavení systému</h2>
                    <button onclick="state.viewMode='manage'; state.configEditingItem=null; render()" class="p-3 bg-slate-200 rounded-xl hover:text-red-500 transition-all"><i data-lucide="x"></i></button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                    <!-- EDITOR -->
                    <div class="lg:col-span-4">
                        <div class="bg-white p-8 rounded-[2.5rem] border border-slate-200 shadow-lg sticky top-28">
                            <h3 class="font-bold uppercase text-[11px] mb-6 text-blue-500 tracking-widest leading-none">${state.configEditingItem ? 'Upravit záznam' : 'Nová položka'}</h3>
                            <form onsubmit="handleConfigSave(event)" class="space-y-5">
                                <div>
                                    <label class="text-[10px] font-bold uppercase text-slate-400 ml-2 block mb-1">Kategorie</label>
                                    <select id="cfgKat" onchange="render()" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none focus:ring-2 focus:ring-blue-600 transition-all">
                                        <option value="Predmet" ${currentKat==='Predmet'?'selected':''}>Předmět</option>
                                        <option value="Trida" ${currentKat==='Trida'?'selected':''}>Třída</option>
                                        <option value="Typ" ${currentKat==='Typ'?'selected':''}>Typ dokumentu</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-[10px] font-bold uppercase text-slate-400 ml-2 block mb-1">Název</label>
                                    <input id="cfgNazev" value="${state.configEditingItem?.nazev || ''}" placeholder="Např. Matematika" required class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none focus:ring-2 focus:ring-blue-600 transition-all">
                                </div>
                                ${currentKat === 'Predmet' ? `
                                <div>
                                    <label class="text-[10px] font-bold uppercase text-slate-400 ml-2 block mb-1">Barva karty</label>
                                    <select id="cfgVal" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none focus:ring-2 focus:ring-blue-600 transition-all">
                                        <option value="modra" ${state.configEditingItem?.hodnota==='modra'?'selected':''}>Modrá</option>
                                        <option value="zelena" ${state.configEditingItem?.hodnota==='zelena'?'selected':''}>Zelená</option>
                                        <option value="cervena" ${state.configEditingItem?.hodnota==='cervena'?'selected':''}>Červená</option>
                                        <option value="zluta" ${state.configEditingItem?.hodnota==='zluta'?'selected':''}>Žlutá</option>
                                        <option value="fialova" ${state.configEditingItem?.hodnota==='fialova'?'selected':''}>Fialová</option>
                                        <option value="oranzova" ${state.configEditingItem?.hodnota==='oranzova'?'selected':''}>Oranžová</option>
                                        <option value="seda" ${state.configEditingItem?.hodnota==='seda'?'selected':''}>Šedá</option>
                                    </select>
                                </div>` : ''}
                                <button ${state.actionLoading?'disabled':''} class="w-full ${state.configEditingItem?'bg-orange-500':'bg-blue-600'} text-white py-5 rounded-[2rem] font-bold uppercase shadow-xl hover:opacity-90 active:scale-95 transition-all disabled:opacity-50">
                                    ${state.actionLoading ? 'Pracuji...' : (state.configEditingItem ? 'Uložit změny' : 'Přidat do systému')}
                                </button>
                                ${state.configEditingItem ? `<button type="button" onclick="state.configEditingItem=null; render()" class="w-full text-slate-400 text-[10px] uppercase font-bold py-2">Zrušit</button>` : ''}
                            </form>
                        </div>
                    </div>
                    <!-- LISTY -->
                    <div class="lg:col-span-8 space-y-6">
                        <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm flex flex-col max-h-[350px]">
                            <h4 class="font-bold text-blue-900 uppercase text-[10px] mb-4 border-b pb-2 tracking-widest leading-none">Předměty</h4>
                            <div class="flex-1 overflow-y-auto custom-scroll space-y-2 pr-2">
                                ${subjects.map(c => `
                                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-2xl border border-slate-100 group animate-in">
                                        <div class="flex items-center gap-3"><span class="w-3 h-3 rounded-full btn-${c.hodnota} shadow-sm"></span><b class="text-sm text-slate-700 font-bold">${c.nazev}</b></div>
                                        <div class="flex gap-1">
                                            <button onclick="state.configEditingItem=${JSON.stringify(c).replace(/"/g, '&quot;')}; render()" class="p-2 text-blue-400 hover:bg-white rounded-lg transition-all"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                                            <button onclick="askConfirm('Smazat?', 'Chcete smazat kategorii ${c.nazev}?', () => { state.config=state.config.filter(i=>i!==c); runAction('deleteConfig',[],{configItem:c}); })" class="p-2 text-red-200 hover:text-red-500 hover:bg-white rounded-lg transition-all"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                        </div>
                                    </div>`).join('')}
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm flex flex-col max-h-[350px]">
                            <h4 class="font-bold text-blue-900 uppercase text-[10px] mb-4 border-b pb-2 tracking-widest leading-none">Třídy a Typy</h4>
                            <div class="flex-1 overflow-y-auto custom-scroll space-y-2 pr-2">
                                ${[...grades, ...types].map(c => `
                                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-2xl border border-slate-100 group animate-in">
                                        <div><b class="text-sm text-slate-700 font-bold">${c.nazev}</b><br><small class="text-[9px] uppercase text-slate-400 font-bold">${c.kategorie}</small></div>
                                        <div class="flex gap-1">
                                            <button onclick="state.configEditingItem=${JSON.stringify(c).replace(/"/g, '&quot;')}; render()" class="p-2 text-blue-400 hover:bg-white rounded-lg transition-all"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                                            <button onclick="askConfirm('Smazat?', 'Chcete smazat položku ${c.nazev}?', () => { state.config=state.config.filter(i=>i!==c); runAction('deleteConfig',[],{configItem:c}); })" class="p-2 text-red-200 hover:text-red-500 hover:bg-white rounded-lg transition-all"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                        </div>
                                    </div>`).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        // --- RENDERER ---
        function render() {
            const app = document.getElementById('app');
            if (state.loading) return;

            // LOGIN
            if (!state.user) {
                app.innerHTML = `<div class="min-h-screen bg-blue-600 flex items-center justify-center p-6 text-slate-900">
                    <div class="max-w-md w-full bg-white rounded-[3.5rem] p-12 shadow-2xl animate-in text-center">
                        <div class="bg-blue-50 w-24 h-24 rounded-[2.5rem] flex items-center justify-center mx-auto mb-8 text-blue-600 shadow-inner"><i data-lucide="school" class="w-12 h-12"></i></div>
                        <h1 class="text-4xl font-black uppercase mb-2 tracking-tight text-blue-900 leading-tight">Domoškola Líšeň</h1>
                        <p class="text-blue-400 font-bold uppercase tracking-widest text-[10px] mb-10">Digitální studovna</p>
                        <form onsubmit="handleLogin(event)" class="space-y-6">
                            <input id="loginEmail" type="email" required placeholder="Tvůj e-mail" class="w-full px-6 py-4 bg-slate-50 border border-slate-100 rounded-2xl text-center outline-none focus:ring-2 focus:ring-blue-600 transition-all shadow-inner">
                            <input id="loginPin" type="password" required placeholder="PIN" class="w-full px-6 py-4 bg-slate-50 border border-slate-100 rounded-2xl text-center font-mono outline-none focus:ring-2 focus:ring-blue-600 transition-all text-2xl tracking-[0.5em] shadow-inner">
                            ${state.loginError?`<p class="text-red-500 text-xs font-bold bg-red-50 p-4 rounded-xl border border-red-100 animate-in">${state.loginError}</p>`:''}
                            <button class="w-full bg-blue-600 text-white py-6 rounded-[2.5rem] font-bold uppercase shadow-xl hover:bg-blue-700 active:scale-95 transition-all text-sm tracking-widest">Vstoupit do studovny</button>
                        </form>
                    </div>
                </div>`; 
                if (window.lucide) lucide.createIcons(); return;
            }

            const gradesList = ["Vše", ...state.config.filter(c => c.kategorie === 'Trida').map(c => c.nazev).sort()];
            
            app.innerHTML = `<div class="min-h-screen flex flex-col animate-in">
                <header class="bg-white border-b border-blue-100 sticky top-0 z-40 px-6 py-4 flex items-center justify-between shadow-sm h-20">
                    <button onclick="location.reload()" class="flex items-center gap-3 group">
                        <div class="bg-blue-600 p-2.5 rounded-2xl text-white shadow-lg group-hover:scale-105 transition-all shadow-blue-100"><i data-lucide="school" class="w-6 h-6"></i></div>
                        <div class="hidden sm:block text-left leading-none"><h1 class="font-bold text-xl text-blue-900 uppercase tracking-tight">Domoškola Líšeň</h1><p class="text-[9px] text-blue-400 font-bold uppercase tracking-widest leading-tight mt-1">Digitální portál</p></div>
                    </button>
                    
                    <div class="relative flex-1 max-w-md hidden lg:block mx-8">
                        <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-blue-200 w-4 h-4"></i>
                        <input type="text" oninput="state.searchQuery=this.value; render()" value="${state.searchQuery}" placeholder="Hledat látku, téma nebo tag..." class="w-full pl-11 pr-4 py-2.5 bg-slate-50 border border-slate-100 rounded-2xl outline-none focus:bg-white focus:ring-2 focus:ring-blue-600 transition-all text-sm shadow-inner">
                    </div>
                    
                    <div class="flex items-center gap-6 shrink-0">
                        <div class="text-right hidden sm:block leading-none">
                            <div class="text-[11px] font-bold uppercase text-blue-900 mb-1">${state.user.name}</div>
                            <div class="text-[8px] font-bold text-blue-300 uppercase tracking-widest font-mono">${state.user.role}</div>
                        </div>
                        <button onclick="state.user=null; localStorage.removeItem('domoskola_user'); render()" class="p-3 bg-slate-50 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-2xl transition-all" title="Odhlásit se"><i data-lucide="log-out" class="w-5 h-5"></i></button>
                    </div>
                </header>
                
                <div class="max-w-7xl mx-auto p-6 flex flex-col lg:flex-row gap-10 flex-1 w-full mt-4">
                    <aside class="lg:w-64 flex-shrink-0">
                        <div class="flex flex-col gap-1 bg-white/60 p-2 rounded-[2.5rem] border border-blue-50 shadow-sm sticky top-28">
                            <h3 class="text-[9px] font-black text-blue-200 uppercase tracking-[0.3em] py-4 text-center">Ročníky</h3>
                            ${gradesList.map(g => `<button onclick="state.activeGrade='${g}'; state.viewMode='portal'; render()" class="px-6 py-4 rounded-2xl font-bold text-xs text-left transition-all ${state.activeGrade===g&&state.viewMode==='portal'?'bg-blue-600 text-white shadow-xl shadow-blue-100 translate-x-2':'text-slate-500 hover:bg-white hover:text-blue-600'}">${g}</button>`).join('')}
                        </div>
                    </aside>
                    <main id="main-content-area" class="flex-1 min-w-0">
                        ${state.viewMode === 'manage' ? renderManageHTML() : state.viewMode === 'config' ? renderConfigHTML() : renderPortalHTML()}
                    </main>
                </div>

                <!-- TOASTY -->
                ${state.toast ? `
                <div class="fixed bottom-8 left-1/2 -translate-x-1/2 z-[100] toast-enter">
                    <div class="bg-blue-600 text-white px-8 py-5 rounded-[2rem] shadow-2xl font-bold uppercase text-[10px] tracking-[0.2em] flex items-center gap-4 border border-blue-500/50">
                        <i data-lucide="check-circle" class="w-5 h-5 text-emerald-300"></i> ${state.toast}
                        <button onclick="state.toast=null; render()" class="ml-4 opacity-50"><i data-lucide="x" class="w-4 h-4"></i></button>
                    </div>
                </div>` : ''}

                <!-- CONFIRM MODAL -->
                ${state.confirmModal ? `
                <div class="fixed inset-0 z-[200] flex items-center justify-center p-6 modal-overlay animate-in">
                    <div class="bg-white rounded-[2.5rem] shadow-2xl p-10 max-w-sm w-full text-center">
                        <h2 class="text-xl font-bold text-blue-900 mb-2 uppercase">${state.confirmModal.title}</h2>
                        <p class="text-slate-500 mb-8 leading-relaxed">${state.confirmModal.text}</p>
                        <div class="flex gap-4">
                            <button onclick="state.confirmModal=null; render()" class="flex-1 py-4 bg-slate-100 rounded-2xl font-bold uppercase text-[10px]">Zpět</button>
                            <button onclick="state.confirmModal.onConfirm(); state.confirmModal=null; render()" class="flex-1 py-4 bg-red-600 text-white rounded-2xl font-bold uppercase text-[10px] shadow-lg shadow-red-100">Potvrdit</button>
                        </div>
                    </div>
                </div>` : ''}

                <!-- MODAL: NAHRÁVÁNÍ -->
                ${state.showUploadModal ? `<div class="fixed inset-0 z-50 flex items-center justify-center p-4 md:p-10 modal-overlay">
                    <div class="bg-white rounded-[3.5rem] shadow-2xl w-full max-w-xl max-h-full flex flex-col animate-in overflow-hidden">
                        <div class="p-8 border-b border-slate-50 flex justify-between items-center shrink-0">
                            <h2 class="text-2xl font-bold text-blue-900 uppercase">Nový materiál</h2>
                            <button onclick="state.showUploadModal=false; render()" class="text-slate-300 hover:text-red-500 transition-all"><i data-lucide="x" class="w-8 h-8"></i></button>
                        </div>
                        <div class="p-8 overflow-y-auto custom-scroll flex-1 relative">
                            ${state.actionLoading?`<div class="absolute inset-0 bg-white/90 z-20 flex flex-col items-center justify-center text-blue-600 font-bold uppercase text-xs animate-in"><div class="animate-spin rounded-full h-16 w-16 border-b-4 border-current mb-4"></div>Ukládám podklady...</div>`:''}
                            <form onsubmit="handleUpload(event)" class="space-y-6 text-sm">
                                <div><label class="text-[10px] font-bold uppercase text-slate-400 ml-2 block mb-2 tracking-widest">1. Soubor</label><input id="uploadFile" type="file" required class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl text-xs"></div>
                                <div><label class="text-[10px] font-bold uppercase text-slate-400 ml-2 block mb-2 tracking-widest">2. Název materiálu</label><input id="metaNazev" placeholder="Co uvidí děti na kartě" required class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none focus:ring-2 focus:ring-blue-600 transition-all"></div>
                                <div><label class="text-[10px] font-bold uppercase text-slate-400 ml-2 block mb-2 tracking-widest">3. Popis / Poznámka</label><textarea id="metaPoznamka" placeholder="Vysvětlení k dokumentu..." class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl h-24 outline-none focus:ring-2 focus:ring-blue-600 transition-all"></textarea></div>
                                <div class="grid grid-cols-2 gap-6">
                                    <div><label class="text-[10px] font-bold uppercase text-slate-400 ml-2 block mb-2 tracking-widest">4. Třída</label><select id="metaTrida" required class="w-full p-4 bg-slate-50 border rounded-2xl outline-none">${state.config.filter(c=>c.kategorie==='Trida').map(c=>`<option>${c.nazev}</option>`).join('')}</select></div>
                                    <div><label class="text-[10px] font-bold uppercase text-slate-400 ml-2 block mb-2 tracking-widest">5. Předmět</label><select id="metaPredmet" required class="w-full p-4 bg-slate-50 border rounded-2xl outline-none">${state.config.filter(c=>c.kategorie==='Predmet').map(c=>`<option>${c.nazev}</option>`).join('')}</select></div>
                                </div>
                                <div class="grid grid-cols-2 gap-6">
                                    <div><label class="text-[10px] font-bold uppercase text-slate-400 ml-2 block mb-2 tracking-widest">6. Typ</label><select id="metaTyp" required class="w-full p-4 bg-slate-50 border rounded-2xl outline-none">${state.config.filter(c=>c.kategorie==='Typ').map(c=>`<option>${c.nazev}</option>`).join('')}</select></div>
                                    <div><label class="text-[10px] font-bold uppercase text-slate-400 ml-2 block mb-2 tracking-widest">7. Tagy</label><input id="metaTagy" placeholder="psaní, gramatika" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none"></div>
                                </div>
                                <button class="w-full bg-emerald-600 text-white py-6 rounded-[2.5rem] font-bold uppercase shadow-xl hover:bg-emerald-700 transition-all active:scale-95 mt-6 tracking-widest text-sm">Publikovat do studovny</button>
                            </form>
                        </div>
                    </div></div>`:''}

                <!-- MODAL: EDITACE -->
                ${state.showEditModal ? `<div class="fixed inset-0 z-50 flex items-center justify-center p-4 md:p-10 modal-overlay">
                    <div class="bg-white rounded-[3.5rem] shadow-2xl w-full max-w-xl max-h-full flex flex-col animate-in overflow-hidden">
                        <div class="p-8 border-b border-slate-50 flex justify-between items-center shrink-0">
                            <h2 class="text-2xl font-bold text-blue-900 uppercase">Upravit materiál</h2>
                            <button onclick="state.showEditModal=null; render()" class="text-slate-300 hover:text-red-500 transition-all"><i data-lucide="x" class="w-8 h-8"></i></button>
                        </div>
                        <div class="p-8 overflow-y-auto custom-scroll flex-1">
                            <form onsubmit="event.preventDefault(); runAction('edit', [], {id: state.showEditModal.id, nazev: document.getElementById('eNazev').value, trida: document.getElementById('eTrida').value, predmet: document.getElementById('ePredmet').value, poznamka: document.getElementById('ePozn').value, typ: document.getElementById('eTyp').value, tagy: document.getElementById('eTagy').value});" class="space-y-6 text-sm">
                                <div><label class="text-[10px] font-bold uppercase text-slate-400 ml-2 block mb-2 tracking-widest leading-none">Název materiálu</label><input id="eNazev" value="${state.showEditModal.nazev}" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none focus:ring-2 focus:ring-blue-600 transition-all shadow-inner"></div>
                                <div><label class="text-[10px] font-bold uppercase text-slate-400 ml-2 block mb-2 tracking-widest leading-none">Popis / Poznámka</label><textarea id="ePozn" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl h-32 outline-none focus:ring-2 focus:ring-blue-600 transition-all shadow-inner">${state.showEditModal.poznamka || ''}</textarea></div>
                                <div class="grid grid-cols-2 gap-6">
                                    <div><label class="text-[10px] font-bold uppercase text-slate-400 ml-2 block mb-2 tracking-widest leading-none">Třída</label><select id="eTrida" class="w-full p-4 bg-slate-50 border rounded-2xl outline-none">${state.config.filter(c=>c.kategorie==='Trida').map(c=>`<option ${c.nazev===state.showEditModal.trida?'selected':''}>${c.nazev}</option>`).join('')}</select></div>
                                    <div><label class="text-[10px] font-bold uppercase text-slate-400 ml-2 block mb-2 tracking-widest leading-none">Předmět</label><select id="ePredmet" class="w-full p-4 bg-slate-50 border rounded-2xl outline-none">${state.config.filter(c=>c.kategorie==='Predmet').map(c=>`<option ${c.nazev===state.showEditModal.predmet?'selected':''}>${c.nazev}</option>`).join('')}</select></div>
                                </div>
                                <div class="grid grid-cols-2 gap-6">
                                    <div><label class="text-[10px] font-bold uppercase text-slate-400 ml-2 block mb-2 tracking-widest leading-none">Typ</label><select id="eTyp" class="w-full p-4 bg-slate-50 border rounded-2xl outline-none">${state.config.filter(c=>c.kategorie==='Typ').map(c=>`<option ${c.nazev===state.showEditModal.typ?'selected':''}>${c.nazev}</option>`).join('')}</select></div>
                                    <div><label class="text-[10px] font-bold uppercase text-slate-400 ml-2 block mb-2 tracking-widest leading-none">Tagy</label><input id="eTagy" value="${state.showEditModal.tagy}" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none shadow-inner"></div>
                                </div>
                                <button class="w-full bg-blue-600 text-white py-6 rounded-[2.5rem] font-bold uppercase shadow-xl hover:bg-blue-700 transition-all active:scale-95 mt-6 text-sm tracking-widest leading-none">Uložit změny v dokumentu</button>
                            </form>
                        </div>
                    </div></div>`:''}

                <footer class="p-16 text-center text-[10px] font-bold uppercase tracking-[0.3em] text-slate-300">
                    © 2026 Domoškola Líšeň • Brno
                </footer>
            </div>`;
            if (window.lucide) lucide.createIcons();
        }

        fetchData();
    </script>
</body>
</html>